### 요구사항 분석

<상품 도메인>

모델 상품 ID <br/>
상품명 <br/>
가격 <br/>
수량

<상품 관리 기능>

상품 목록 <br/>
상품 상세 <br/>
상품 등록 <br/>
상품 수정

<서비스 흐름>

![image](https://user-images.githubusercontent.com/78454649/174251702-7f7c9c88-1b23-4554-9215-ee79b4e851be.png)

<br/>

### 상품 도메인 개발

* Item

```java

@Data
public class Item {

    private Long id;
    private String itemName;
    private Integer price;
    private Integer quantity;

    public Item() {
    }

    public Item(String itemName, Integer price, Integer quantity) {
        this.itemName = itemName;
        this.price = price;
        this.quantity = quantity;
    }
}

```

+) 참고 <br/>
롬복 사용시 @Data는 이런 핵심 도메인에서는 위험할 수 있다. (ex. @ToString - 양방향 연관관계 무한 루프) <br/>
@Getter, @Setter 혹은 @Getter 정도만 열어두는 것이 좋다. (Dto에서는 @Data를 조심히 사용해도 좋다)

<br/>

* itemRepository

```java

@Repository
public class ItemRepository {

    private static final Map<Long, Item> store = new HashMap<>(); //static , 싱글톤은 보장하기 위해
    private static long sequence = 0L; //static

    public Item save(Item item) {
        item.setId(++sequence);
        store.put(item.getId(), item);
        return item;
    }

    public Item findById(Long id) {
        return store.get(id);
    }

    public List<Item> findAll() {
        return new ArrayList<>(store.values());
    }

    public void update(Long itemId, Item updateParam) {
        Item findItem = findById(itemId);
        findItem.setItemName(updateParam.getItemName());
        findItem.setPrice(updateParam.getPrice());
        findItem.setQuantity(updateParam.getQuantity());
    }

    public void clearStore() {
        store.clear();
    }
}

```

저장소는 정적 메모리 저장소를 사용하고, id 값을 위해 정적 변수 sequence를 사용한다.<br/>
+) 싱글톤을 사용하기 때문에 사용자 동시 접근을 고려하여 ConcurrentHashMap이나 AtomicLong을 사용하는 것이 좋다. (여기서는 간단히)

+) 상품 목록의 경우 ArrayList로 한 번 감쌌는데 이는 중간에 store가 <br/>
수정되는 등의 상황에 대해 안전하게 상품 목록을 반환해주기 위해서이다.

+) 상품 수정에서 setter를 세 번 사용했는데 사실 정석은 세 필드를 포함하는 Dto를 통해 수정 정보를 명확히 하는 것이 좋다.

<br/>

---

<br/>

### 상품 서비스 HTML

<br/>

핵심 비즈니스 로직을 개발하는 동안, 웹 퍼블리셔가 HTML 마크업을 완료했다고 하자. <br/>
이제 제공 받은 HTML 파일들을 경로에 넣고 잘 동작하는지 확인하면 된다.

 

<부트스트랩>

부트스트랩은 웹사이트를 쉽게 만들 수 있게 도와주는 HTML, CSS, JS 프레임워크다.

-> 부트스트랩을 다운로드 받는다.

이동: https://getbootstrap.com/docs/5.0/getting-started/download/

압축을 풀고 bootstrap.min.css를 복사해서 resources/static/ 폴더에 추가하자.

 

<HTML, CSS 파일>

/resources/static/css/bootstrap.min.css <br/>
/resources/static/html/items.html <br/>
/resources/static/html/item.html <br/>
/resources/static/html/addForm.html <br/>
/resources/static/html/editForm.html <br/>

-> 위 파일들을 제공받았다고 가정하자. 지금은 백엔드 개발에 집중하기 때문에 코드 상세 내용은 넘어간다.

(모든 코드는 깃허브에 올려두었다)

 

+) 참고

이렇게 정적 리소스가 공개되는 /resources/static 폴더에 HTML을 넣어두면, 실제 서비스에서도 공개된다. <br/>
어차피 해당 리소스들을 타임리프 템플릿으로 수정할 것이기 때문에 지금처럼 바로 공개할 필요 없는 HTML을 해당 폴더에 두는 것은 주의하자.

<br/>

---

<br/>

### 타임리프

본격적으로 컨트롤러와 뷰 템플릿을 개발해보자.

<br/>

#### 컨트롤러

* BasicItemController

```java

@Controller
@RequestMapping("/basic/items")
@RequiredArgsConstructor
public class BasicItemController {

    private final ItemRepository itemRepository;

    @GetMapping
    public String items(Model model) {
        List<Item> items = itemRepository.findAll();
        model.addAttribute("items", items);
        return "basic/items";
    }

    /**
     * 테스트용 데이터 추가
     */
    @PostConstruct
    public void init() {
        itemRepository.save(new Item("itemA", 10000, 10));
        itemRepository.save(new Item("itemB", 20000, 20));
    }
}

```

컨트롤러는 상품 저장소를 사용하기 위해 itemRepository를 의존해야 한다. <br/>
이 때 롬복의 @RequiredArgsConstructor를 사용해서 의존관계 주입을 했다.


테스트용 데이터를 추가하기 위해 빈 초기화 기능을 사용했다. <br/>
@PostConstruct : 해당 빈의 의존관계가 모두 주입되고 나면 초기화 용도로 호출된다.

<br/>

#### 뷰 템플릿

이제 items.html 정적 HTML 파일을 뷰 템플릿 영역으로 복사하고 다음과 같이 수정하자.

* items

```html

<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <link th:href="@{/css/bootstrap.min.css}"
            href="../css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container" style="max-width: 600px">
    <div class="py-5 text-center">
        <h2>상품 목록</h2>
    </div>
    <div class="row">
        <div class="col">
            <button class="btn btn-primary float-end"
                    onclick="location.href='addForm.html'"
                    th:onclick="|location.href='@{/basic/items/add}'|"
                    type="button">상품 등록</button>
        </div>
    </div>
    <hr class="my-4">
    <div>
        <table class="table">
            <thead>
            <tr>
                <th>ID</th>
                <th>상품명</th>
                <th>가격</th>
                <th>수량</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${items}">
                <td><a href="item.html" th:href="@{/basic/items/{itemId}(itemId=${item.id})}" th:text="${item.id}">회원id</a></td>
                <td><a href="item.html" th:href="@{|/basic/items/${item.id}|}" th:text="${item.itemName}">상품명</a></td>
                <td th:text="${item.price}">10000</td>
                <td th:text="${item.quantity}">10</td>
            </tr>
            </tbody>
        </table>
    </div>
</div> <!-- /container -->
</body>
</html>

```

* 타임리프 사용 선언

```html

<html xmlns:th="http://www.thymeleaf.org">

```

<br/>

* 속성 변경 - th:href

```html

<link th:href="@{/css/bootstrap.min.css}"
            href="../css/bootstrap.min.css" rel="stylesheet">

```

타임리프 사용시 이렇게 html태그에 th를 추가하면 렌더링시 href="value1"을 th:href="value2" 값으로 변경한다.(value2가 있을 시)

즉, HTML을 그대로 볼 때는 href 속성이 사용되고, 뷰 템플릿을 거치면 th:href의 값이 href로 대체되면서 동적으로 변경할 수 있다.
-> 대부분의 HTML 속성을 th:xxx로 변경할 수 있다. <br/>

<br/>

* 타임리프 핵심

핵심은 th:xxx가 붙은 부분은 서버사이드에서 렌더링 되고, 기존 것을 대체한다. th.xxx가 없으면 기존 html의 xxx 속성이 그대로 사용된다.

HTML을 파일로 직접 열었을 때는, th:xxx가 있어도 웹 브라우저는 th: 속성을 알지 못하므로 무시한다. <br/>
-> 따라서 **HTML 파일 보기를 유지하면서 템플릿 기능**도 사용할 수 있다.

<br/>

* URL 링크 표현식 - @{...}

```html

<link th:href="@{/css/bootstrap.min.css}"
            href="../css/bootstrap.min.css" rel="stylesheet">

```

@{...} : 타임리프는 URL 링크를 사용하는 경우 @{...}를 사용한다.


+) 참고 : 자바에서 링크를 나타낼 때

1. 앞에 '/'가 붙는다 : host 뒤에 바로 주소를 붙인다.

ex.) <br/>
현재 resources/static/css/bootstrap.min.css에 파일을 불러와야 하는 상황

현재 파일 경로 : http://localhost:8080/basic/items.html <br/>
Link to **/css/bootstrap.min.css** -> localhost:8080/css/bootstrap.min.css <br/>
그리고 스프링 MVC는 이 경로를 받아서 resources/static/css/bootstrap.min.css를 반환한다.


2. 앞에 '/'가 붙지 않는다 : 현재 디렉토리에서 주소를 붙인다.

ex) <br/>
현재 URL : http://localhost:8080/basic/items.html <br/>
Link to **css/bootstrap.min.css** -> http://localhost:8080/basic/css/bootstrap.min.css <br/>
이런 파일은 존재하지 않기 때문에 불러올 수 없다.

<br/>

* 속성 변경 - th:onclick

```html

onclick="location.href='addForm.html'"
th:onclick="|location.href='@{/basic/items/add}'|"

```

여기에는 다음에 설명하는 리터럴 대체 문법이 사용되었다.

<br/>

* 리터럴 대체 - |...|

타임리프에서 문자와 표현식은 분리되어 있기 때문에 더해서 사용해야 한다. <br/>
th:onclick="'location.href=' + '\'' + @{/basic/items/add} + '\''" <br/>
리터럴 대체 문법을 사용하면 다음과 같이 편리하게 사용할 수 있다. <br/>
th:onclick="|location.href='@{/basic/items/add}'|"

<br/>

* 반복 출력 - th:each

```java

<tr th:each="item : ${items}">

```

이렇게 하면 모델에 포함된 items 컬렉션 데이터가 item 변수에 하나씩 포함되고, 반복문 안에서 item 변수를 사용할 수 있다.

<br/>

* 변수 표현식 - ${...}

```java

<td th:text="${item.price}">10000</td>
<td th:text="${item.quantity}">10</td>

```

모델에 포함된 값이나, 타임리프 변수로 선언한 값을 조회할 수 있다. <br/>
프로퍼티 접근법을 사용한다 (item.getPrice())

<br/>

* 내용 변경 - th:text

```html

<td th:text="${item.price}">10000</td>

```

내용의 값을 th:text의 값으로 변경한다. 여기서는 10000을 ${item.price}로 변경한다.

<br/>

* URL 링크 표현식2 - @{...}

```java

// 여기서 경로변수 안에 있는 itemId는 ()안에 있는 itemId
th:href="@{/basic/items/{itemId}(itemId=${item.id})}"

```

타임리프 문법을 사용하여 URL 링크 표현식에서 경로 변수 {itemId}를 사용했다. <br/>
경로 변수 뿐만 아니라 쿼리 파라미터도 생성 가능하다. <br/>
ex) <br/>
th:href="@{/basic/items/{itemId}(itemId=${item.id}, query='test')}" <br/>
생성 링크: http://localhost:8080/basic/items/1?query=test

<br/>

* URL 링크 간단히

```java

th:href="@{|/basic/items/${item.id}|}"

```

<br/>

+) 참고

타임리프는 순수 HTML 파일을 웹 브라우저에서 열어도 내용을 확인할 수 있고, <br/>
서버를 통해 뷰 템플릿을 거치면 동적으로 변경된 결과를 확인할 수 있다.

JSP를 생각해보면, JSP 파일은 웹 브라우저에서 그냥 열면 JSP와 HTML이 섞여 있어 정상적인 확인이 불가능하다. <br/>
오직 서버를 통해서 JSP를 열어야 한다.

이렇게 순수 HTML을 그대로 유지하면서 뷰 템플릿도 사용할 수 있는 타임리프의 특징을 네츄럴 템플릿(natural templates)이라 한다.

<br/>

---

<br/>




























